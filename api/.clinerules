# Cline Rules - API Module

> **重要**: タスク開始時、`/workspace/memory-bank/` と `/workspace/api/memory-bank/` の両方を読み込むこと。

## ロール定義

FastAPI + PostgreSQL のエキスパートエンジニアとして対応する。

## コーディング規約

- Gitコミットメッセージ: 日本語
- コード中コメント: 日本語
- ログメッセージ: 日本語（`mixins/log.py` の `setup_logger` を使用）
- Workerログ: 対象不存在でスキップする場合はログ出力しない
- 型ヒント: 必須
- スキーマ: Pydantic V2 + `BaseSchema`（`mixins/schema.py`）でsnake_case↔camelCase自動変換
- DB変更時: 必ずAlembicマイグレーションファイルを作成

## 技術スタック

- Python 3.11+ / FastAPI / SQLAlchemy 2.0 / Alembic / PostgreSQL 16
- 認証: PyJWT + bcrypt（OAuth2 Password Flow）
- 画像処理: Pillow + OpenCV + ImageHash
- 本番: Gunicorn / 開発: Uvicorn（`python3 main.py`）
- コンテナ: Docker Compose

## アーキテクチャ

- ドメイン別モジュール分割: `{domain}/models.py`, `router.py`, `schemas.py`
- 共通ユーティリティ: `mixins/`
- バックグラウンドタスク: `tasks/` + `worker.py`（DBベースのタスクキュー）
- 依存性注入: `Depends(get_db)`, `Depends(get_current_user)`

## 既知の注意点

- DBカラムのタイポ: `chached`(→cached), `is_shered`(→is_shared) — マイグレーション済み（20260210）
- フロントエンド認証タイポ: `authenticaitonSuccessful`/`authenticaitonFail` — 互換性のため維持
- `API_VERSION = '3.0.0'` はsettings.pyでハードコード
- ファイル名長制限: OSError対策が不完全（Zip展開時）

## 開発コマンド

```bash
python3 main.py                          # 開発サーバー
python3 worker.py                        # Worker起動
alembic revision --autogenerate -m "説明"  # マイグレーション作成
alembic upgrade head                     # マイグレーション適用
ruff check . --fix                       # Lintチェック・修正
```
